/*!
 * image-process v0.0.1
 * (c) 2017-2017 dailc
 * Released under the MIT License.
 * https://github.com/dailc/image-process
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.ImageClip=i()}(this,function(){"use strict";function t(t){for(var i=t,s=arguments.length,e=Array(s>1?s-1:0),a=1;a<s;a++)e[a-1]=arguments[a];return e.forEach(function(t){t&&Object.keys(t).forEach(function(s){i[s]=t[s]})}),i}function i(t){var i=t;return"string"==typeof i&&(i=document.querySelector(i)),i}function s(t){(function(t){this.os={};var i=t.match(/(Android);?[\s/]+([\d.]+)?/);i&&(this.os.android=!0,this.os.version=i[2],this.os.isBadAndroid=!/Chrome\/\d/.test(window.navigator.appVersion));var s=t.match(/(iPhone\sOS)\s([\d_]+)/);s&&(this.os.ios=!0,this.os.iphone=!0,this.os.version=s[2].replace(/_/g,"."));var e=t.match(/(iPad).*OS\s([\d_]+)/);e&&(this.os.ios=!0,this.os.ipad=!0,this.os.version=e[2].replace(/_/g,"."));var a=t.match(/EpointEJS/i);a&&(this.os.ejs=!0);var h=t.match(/DingTalk/i);h&&(this.os.dd=!0),a||h||(this.os.h5=!0)}).call(t,navigator.userAgent)}function e(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var a=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}(),h={container:"#imgclip",img:null,quality:.92,isSmooth:!0,captureRadius:30,iphoneFixedRatio:2,sizeTipsStyle:0,compressScaleRatio:1,maxCssHeight:null,mime:"image/jpeg"},n=[],c={};return function(){function l(a){e(this,l),this.options=t({},h,a),this.container=i(this.options.container),s(this),this.clear(),this.img=this.options.img,this.initCanvas(),this.initClip(),this.initMagnifier(),this.initTransferCanvas(),this.clipRectReset()}return a(l,[{key:"getPixelRatio",value:function(t){var i=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,s=(window.devicePixelRatio||1)/i;return s*=this.options.compressScaleRatio||1,this.os.ios&&this.os.iphone&&(s*=this.options.iphoneFixedRatio||1),s}},{key:"clear",value:function(){for(var t=0;t<n.length;t+=1)this.container.removeChild(n[t]);n=[];for(var i=Object.keys(c),s=0;s<i.length;s+=1)this.container.removeEventListener(i[s],c[i[s]]);c={}}},{key:"initCanvas",value:function(){this.canvasFull=document.createElement("canvas"),this.ctxFull=this.canvasFull.getContext("2d"),this.canvasFull.className="clip-canvas-full",this.smoothCtx(this.ctxFull),this.RATIO_PIXEL=this.getPixelRatio(this.ctxFull);var t=this.img.width/this.img.height,i=this.container.offsetWidth||window.innerWidth;this.oldWidth=i,this.oldHeight=i/t,this.resizeCanvas(i,this.oldHeight),this.container.appendChild(this.canvasFull),n.push(this.canvasFull)}},{key:"resizeCanvas",value:function(t,i){var s=this.options.maxCssHeight,e=t/i,a=this.oldWidth,h=a/e;s&&h>s&&(a=(h=s)*e),this.marginLeft=(this.oldWidth-a)/2,this.canvasFull.style.width=a+"px",this.canvasFull.style.height=h+"px",this.canvasFull.style.marginLeft=this.marginLeft+"px",this.canvasFull.width=a*this.RATIO_PIXEL,this.canvasFull.height=h*this.RATIO_PIXEL,1&this.rotateStep?this.scale=this.canvasFull.width/this.img.height:this.scale=this.canvasFull.width/this.img.width}},{key:"initClip",value:function(){var t=document.createElement("div");t.className="clip-rect",this.clipRect=t,this.container.appendChild(this.clipRect),n.push(this.clipRect);var i=document.createElement("span");i.className="clip-tips",this.clipRect.appendChild(i),this.clipTips=i,-1!==this.options.sizeTipsStyle&&0!==this.options.sizeTipsStyle||this.clipTips.classList.add("clip-hidden"),this.clipRectHorns=[];for(var s=0;s<8;s+=1){var e=document.createElement("span");e.className="clip-rect-horn ",0===s?e.className+="horn-nw":1===s?e.className+="horn-ne":2===s?e.className+="horn-sw":3===s?e.className+="horn-se":4===s?e.className+="horn-n":5===s?e.className+="horn-s":6===s?e.className+="horn-w":7===s&&(e.className+="horn-e"),this.clipRect.appendChild(e),this.clipRectHorns.push(e)}this.clipEventState={},this.resizeClip()}},{key:"resizeClip",value:function(){var t=this,i=function(i,s){var e=s-t.canvasFull.offsetTop-t.container.offsetTop,a=i-t.canvasFull.offsetLeft-t.container.offsetLeft;return e=Math.min(e,t.canvasFull.offsetHeight),e=Math.max(0,e),a=Math.min(a,t.canvasFull.offsetWidth),a=Math.max(0,a),t.curX=a,t.curY=e,{curX:a,curY:e}},s=function(s){if(t.canResizing){s.preventDefault(),s.stopPropagation();var e=t.clipEventState,a=e.evnt.target,h=s.touches?s.touches[0].pageY:s.pageY,n=s.touches?s.touches[0].pageX:s.pageX,c=i(n,h),l=c.curX,o=c.curY,r=void 0,u=void 0,v=void 0,g=void 0;a.classList.contains("horn-nw")?(r=e.width-(l-e.left),u=e.height-(o-e.top),v=l,g=o):a.classList.contains("horn-ne")?(r=l-e.left,u=e.height-(o-e.top),v=e.left,g=o):a.classList.contains("horn-sw")?(r=e.width-(l-e.left),u=o-e.top,v=l,g=e.top):a.classList.contains("horn-se")?(r=l-e.left,u=o-e.top,v=e.left,g=e.top):a.classList.contains("horn-n")?(r=e.width,u=e.height-(o-e.top),v=e.left,g=o):a.classList.contains("horn-s")?(r=e.width,u=o-e.top,v=e.left,g=e.top):a.classList.contains("horn-w")?(r=e.width-(l-e.left),u=e.height,v=l,g=e.top):a.classList.contains("horn-e")&&(r=l-e.left,u=e.height,v=l-r,g=e.top),t.clipRect.style.left=v+t.marginLeft+"px",t.clipRect.style.top=g+"px",t.clipRect.style.width=r+"px",t.clipRect.style.height=u+"px",t.draw()}};this.container.addEventListener("touchmove",s),this.container.addEventListener("mousemove",s),c.touchmove=s,c.mousemove=s;for(var e=function(s){t.canResizing=!0,t.saveEventState(s),t.canvasMag.classList.remove("clip-hidden"),0===t.options.sizeTipsStyle&&t.clipTips.classList.remove("clip-hidden");var e=s.touches?s.touches[0].pageY:s.pageY,a=s.touches?s.touches[0].pageX:s.pageX;i(a,e),t.draw()},a=function(){t.canResizing=!1,t.canvasMag.classList.add("clip-hidden"),0===t.options.sizeTipsStyle&&t.clipTips.classList.add("clip-hidden")},h=0;h<8;h+=1)this.clipRectHorns[h].addEventListener("mousedown",e),this.clipRectHorns[h].addEventListener("touchstart",e),this.clipRectHorns[h].addEventListener("mouseup",a),this.clipRectHorns[h].addEventListener("touchend",a);this.container.addEventListener("mouseleave",a),this.container.addEventListener("mouseup",a),c.mouseleave=a,c.mouseup=a}},{key:"saveEventState",value:function(t){this.clipEventState.width=this.clipRect.offsetWidth,this.clipEventState.height=this.clipRect.offsetHeight,this.clipEventState.left=this.clipRect.offsetLeft-this.marginLeft,this.clipEventState.top=this.clipRect.offsetTop,this.clipEventState.mouseX=t.touches?t.touches[0].pageX:t.pageX,this.clipEventState.mouseY=t.touches?t.touches[0].pageY:t.pageY,this.clipEventState.evnt=t}},{key:"draw",value:function(){this.drawMag();var t=this.getRealFinalImgSize(this.clipRect.offsetWidth*this.RATIO_PIXEL,this.clipRect.offsetHeight*this.RATIO_PIXEL),i=t.width,s=t.height;this.clipTips.innerText=i.toFixed(0)+"*"+s.toFixed(0),this.ctxFull.save(),1&this.rotateStep?this.ctxFull.clearRect(0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.clearRect(0,0,this.canvasFull.width,this.canvasFull.height),this.drawImage(),this.drawMask(),this.ctxFull.beginPath();var e=this.getClipRectParams(),a=e.srcX,h=e.srcY,n=e.sWidth,c=e.sHeight;this.ctxFull.rect(a,h,n,c),this.ctxFull.clip(),this.drawImage(),this.ctxFull.restore()}},{key:"getClipRectParams",value:function(){var t=this.clipRect.offsetTop,i=this.clipRect.offsetLeft-this.marginLeft,s=this.clipRect.offsetWidth,e=this.clipRect.offsetHeight,a=i+s,h=t+e,n=i,c=t,l=s,o=e;return 1===this.rotateStep?(n=t,c=this.canvasFull.offsetWidth-a,l=e,o=s):2===this.rotateStep?(n=this.canvasFull.offsetWidth-a,c=this.canvasFull.offsetHeight-h,l=s,o=e):3===this.rotateStep&&(n=this.canvasFull.offsetHeight-h,c=i,l=e,o=s),n*=this.RATIO_PIXEL,c*=this.RATIO_PIXEL,l*=this.RATIO_PIXEL,o*=this.RATIO_PIXEL,{srcX:n,srcY:c,sWidth:l,sHeight:o}}},{key:"getRealCoordinate",value:function(t,i){var s=t,e=i;return 1===this.rotateStep?(s=i,e=this.canvasFull.offsetWidth-t):2===this.rotateStep?(s=this.canvasFull.offsetWidth-t,e=this.canvasFull.offsetHeight-i):3===this.rotateStep&&(s=this.canvasFull.offsetHeight-i,e=t),s*=this.RATIO_PIXEL,e*=this.RATIO_PIXEL,{x:s,y:e}}},{key:"drawImage",value:function(){1&this.rotateStep?this.ctxFull.drawImage(this.img,0,0,this.img.width,this.img.height,0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.drawImage(this.img,0,0,this.img.width,this.img.height,0,0,this.canvasFull.width,this.canvasFull.height)}},{key:"drawMask",value:function(){this.ctxFull.save(),this.ctxFull.fillStyle="rgba(0, 0, 0, 0.3)",1&this.rotateStep?this.ctxFull.fillRect(0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.fillRect(0,0,this.canvasFull.width,this.canvasFull.height),this.ctxFull.restore()}},{key:"drawMag",value:function(){var t=this.options.captureRadius,i=this.getRealCoordinate(this.curX,this.curY),s=2*t,e=2*t,a=i.x-t,h=i.y-t;1&this.rotateStep?this.ctxMag.clearRect(0,0,this.canvasMag.height,this.canvasMag.width):this.ctxMag.clearRect(0,0,this.canvasMag.width,this.canvasMag.height);var n=0,c=0;this.os.ios&&(h<0&&(c=this.canvasMag.height/2*Math.abs(h/t),h=0),a<0&&(n=this.canvasMag.width/2*Math.abs(a/t),a=0)),this.ctxMag.drawImage(this.img,a/this.scale,h/this.scale,s/this.scale,e/this.scale,n,c,this.canvasMag.width,this.canvasMag.height);var l=this.canvasMag.width/2,o=this.canvasMag.height/2,r=5*this.RATIO_PIXEL;this.ctxMag.beginPath(),this.ctxMag.moveTo(l-r,o),this.ctxMag.lineTo(l+r,o),this.ctxMag.moveTo(l,o-r),this.ctxMag.lineTo(l,o+r),this.ctxMag.strokeStyle="#de3c50",this.ctxMag.lineWidth=3,this.ctxMag.stroke()}},{key:"initMagnifier",value:function(){this.canvasMag=document.createElement("canvas"),this.canvasMag.className="magnifier clip-hidden",this.ctxMag=this.canvasMag.getContext("2d"),this.smoothCtx(this.ctxMag),this.container.appendChild(this.canvasMag),n.push(this.canvasMag),this.canvasMag.width=2*this.options.captureRadius*this.RATIO_PIXEL,this.canvasMag.height=2*this.options.captureRadius*this.RATIO_PIXEL}},{key:"initTransferCanvas",value:function(){this.canvasTransfer=document.createElement("canvas"),this.canvasTransfer.style.display="none",this.canvasTransfer.className="transfer-canvas",this.ctxTransfer=this.canvasTransfer.getContext("2d"),this.smoothCtx(this.ctxTransfer),this.container.appendChild(this.canvasTransfer),n.push(this.canvasTransfer)}},{key:"smoothCtx",value:function(t){var i=this.options.isSmooth;t.mozImageSmoothingEnabled=i,t.webkitImageSmoothingEnabled=i,t.msImageSmoothingEnabled=i,t.imageSmoothingEnabled=i}},{key:"getRealFinalImgSize",value:function(t,i){var s=t,e=i;return 1&this.rotateStep?this.canvasFull.width>this.img.height&&(s=this.img.width*t/this.canvasFull.height,e=this.img.height*i/this.canvasFull.width):this.canvasFull.width>this.img.width&&(s=this.img.width*t/this.canvasFull.width,e=this.img.height*i/this.canvasFull.height),{width:s,height:e}}},{key:"clip",value:function(){var t=this.getClipRectParams(),i=t.srcX,s=t.srcY,e=t.sWidth,a=t.sHeight,h=this.getRealFinalImgSize(e,a),n=h.width,c=h.height;this.rotateStep=this.rotateStep||0;var l=90*this.rotateStep*Math.PI/180;0===this.rotateStep?(this.canvasTransfer.width=n,this.canvasTransfer.height=c):1===this.rotateStep?(this.canvasTransfer.width=c,this.canvasTransfer.height=n,this.ctxTransfer.rotate(l),this.ctxTransfer.translate(0,-this.canvasTransfer.width)):2===this.rotateStep?(this.canvasTransfer.width=n,this.canvasTransfer.height=c,this.ctxTransfer.rotate(l),this.ctxTransfer.translate(-this.canvasTransfer.width,-this.canvasTransfer.height)):3===this.rotateStep&&(this.canvasTransfer.width=c,this.canvasTransfer.height=n,this.ctxTransfer.rotate(l),this.ctxTransfer.translate(-this.canvasTransfer.height,0)),1&this.rotateStep?this.ctxTransfer.drawImage(this.img,i/this.scale,s/this.scale,e/this.scale,a/this.scale,0,0,this.canvasTransfer.height,this.canvasTransfer.width):this.ctxTransfer.drawImage(this.img,i/this.scale,s/this.scale,e/this.scale,a/this.scale,0,0,this.canvasTransfer.width,this.canvasTransfer.height),this.clipImgData=this.canvasTransfer.toDataURL(this.options.mime,this.options.quality)}},{key:"clipRectReset",value:function(){this.clipRect.style.left=(this.marginLeft||0)+"px",this.clipRect.style.top=0,this.clipRect.style.width=this.canvasFull.width/this.RATIO_PIXEL+"px",this.clipRect.style.height=this.canvasFull.height/this.RATIO_PIXEL+"px",this.draw()}},{key:"getClipImgData",value:function(){return this.clipImgData}},{key:"rotate",value:function(t){var i=this.oldWidth,s=this.oldHeight;this.rotateStep=this.rotateStep||0,this.rotateStep+=t?1:-1,this.rotateStep>3?this.rotateStep=0:this.rotateStep<0&&(this.rotateStep=3);var e=90*this.rotateStep*Math.PI/180;this.canvasMag.width=this.canvasMag.width,this.canvasMag.height=this.canvasMag.height,0===this.rotateStep?this.resizeCanvas(i,s):1===this.rotateStep?(this.resizeCanvas(s,i),this.ctxFull.rotate(e),this.ctxFull.translate(0,-this.canvasFull.width),this.ctxMag.rotate(e),this.ctxMag.translate(0,-this.canvasMag.width)):2===this.rotateStep?(this.resizeCanvas(i,s),this.ctxFull.rotate(e),this.ctxFull.translate(-this.canvasFull.width,-this.canvasFull.height),this.ctxMag.rotate(e),this.ctxMag.translate(-this.canvasMag.width,-this.canvasMag.height)):3===this.rotateStep&&(this.resizeCanvas(s,i),this.ctxFull.rotate(e),this.ctxFull.translate(-this.canvasFull.height,0),this.ctxMag.rotate(e),this.ctxMag.translate(-this.canvasMag.height,0)),this.clipRectReset()}},{key:"destroy",value:function(){this.clear(),this.canvasFull=null,this.ctxFull=null,this.canvasTransfer=null,this.ctxTransfer=null,this.canvasMag=null,this.ctxMag=null,this.clipRect=null}}]),l}()});