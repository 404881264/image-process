/*!
 * image-process v0.0.1
 * (c) 2017-2017 dailc
 * Released under the MIT License.
 * https://github.com/dailc/image-process
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.ImageProcess=i()}(this,function(){"use strict";function t(t,i,e,a,s,h){for(var n=s/i,c=h/e,r=a,o=0;o<s;o+=1)for(var l=0;l<h;l+=1)!function(a,h){var o=Math.min(i-1,a/n),l=Math.min(e-1,h/c),v=Math.floor(o),u=Math.floor(l),g=h*s+a,f=u*i+v;g*=4,f*=4;for(var d=0;d<=3;d+=1)r[g+d]=t[f+d]}(o,l)}function i(i,e){return t(i.data,i.width,i.height,e.data,e.width,e.height),e}function e(t,i,e,a,s){var h=a,n=s;h>=e?h=e-1:h<0&&(h=0),n>=i?n=i-1:n<0&&(n=0);var c=h*i+n;return c*=4,[t[c+0],t[c+1],t[c+2],t[c+3]]}function a(t,i,a,s,h,n){for(var c=h/i,r=n/a,o=s,l=0;l<h;l+=1)for(var v=0;v<n;v+=1)!function(s,n){var l=Math.min(i-1,s/c),v=Math.min(a-1,n/r),u=Math.floor(l),g=Math.floor(v),f=l-u,d=v-g,p=1-f,m=1-d,w=n*h+s;w*=4;for(var x=e(t,i,a,g+0,u+0),R=e(t,i,a,g+0,u+1),M=e(t,i,a,g+1,u+0),T=e(t,i,a,g+1,u+1),F=0;F<=3;F+=1){var S=d*(p*M[F]+f*T[F]),I=m*(p*x[F]+f*R[F]);o[w+F]=S+I}}(l,v)}function s(t,i){return a(t.data,t.width,t.height,i.data,i.width,i.height),i}function h(t,i,e,a,s,h){for(var n=a,c=s/i,r=h/e,o=0;o<s;o+=1)for(var l=0;l<h;l+=1)!function(a,h){var o=Math.min(i-1,a/c),l=Math.min(e-1,h/r),v=Math.floor(o),u=Math.floor(l),g=o-v,f=l-u,d=h*s+a;d*=4;for(var p=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],m=0;m<=3;m+=1){for(var w=-1;w<=2;w+=1)for(var x=-1;x<=2;x+=1)p[w+1][x+1]=P(t,i,e,u+w,v+x,m);O(p),n[d+m]=X(H(f,g))}}(o,l)}function n(t,i){return h(t.data,t.width,t.height,i.data,i.width,i.height),i}function c(t){var i=t>=0?t:-t,e=t*t,a=i*e;return i<=1?1-(b+3)*e+(b+2)*a:i<=2?-4*b+8*b*i-5*b*e+b*a:0}function r(t){var i=t;return i=Math.min(255,i),i=Math.max(0,i)}function o(t,i,e,a,s){var h=a,n=s;h>=e?h=e-1:h<0&&(h=0),n>=i?n=i-1:n<0&&(n=0);var c=h*i+n;return c*=4,[t[c+0],t[c+1],t[c+2],t[c+3]]}function l(t,i,e,a,s,h){for(var n=a,l=s/i,v=h/e,u=0;u<s;u+=1)for(var g=0;g<h;g+=1)!function(a,h){var u=Math.min(i-1,a/l),g=Math.min(e-1,h/v),f=Math.floor(u),d=Math.floor(g),p=u-f,m=g-d,w=h*s+a;w*=4;for(var x=[0,0,0,0],R=-1;R<=2;R+=1)for(var M=-1;M<=2;M+=1){var T=o(t,i,e,d+R,f+M),F=c(R-m)*c(M-p);x[0]+=T[0]*F,x[1]+=T[1]*F,x[2]+=T[2]*F,x[3]+=T[3]*F}n[w+0]=r(x[0]),n[w+1]=r(x[1]),n[w+2]=r(x[2]),n[w+3]=r(x[3])}(u,g)}function v(t,i){return l(t.data,t.width,t.height,i.data,i.width,i.height),i}function u(t){for(var i=t,e=arguments.length,a=Array(e>1?e-1:0),s=1;s<e;s++)a[s-1]=arguments[s];return a.forEach(function(t){t&&Object.keys(t).forEach(function(e){i[e]=t[e]})}),i}function g(t){var i=t;return"string"==typeof i&&(i=document.querySelector(i)),i}function f(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var d=void 0,p=void 0,m=void 0,w=void 0,x=void 0,R=void 0,M=void 0,T=void 0,F=void 0,S=void 0,I=void 0,y=void 0,E=void 0,L=void 0,C=void 0,k=void 0,P=function(t,i,e,a,s,h){var n=a,c=s;n>=e?n=e-1:n<0&&(n=0),c>=i?c=i-1:c<0&&(c=0);var r=n*i+c;return r*=4,t[r+h]},X=function(t){var i=t;return i=Math.min(255,i),i=Math.max(0,i)},O=function(t){var i=t;d=i[1][1],p=-.5*i[1][0]+.5*i[1][2],m=i[1][0]-2.5*i[1][1]+2*i[1][2]-.5*i[1][3],w=-.5*i[1][0]+1.5*i[1][1]-1.5*i[1][2]+.5*i[1][3],x=-.5*i[0][1]+.5*i[2][1],R=.25*i[0][0]-.25*i[0][2]-.25*i[2][0]+.25*i[2][2],M=-.5*i[0][0]+1.25*i[0][1]-i[0][2]+.25*i[0][3]+.5*i[2][0]-1.25*i[2][1]+i[2][2]-.25*i[2][3],T=.25*i[0][0]-.75*i[0][1]+.75*i[0][2]-.25*i[0][3]-.25*i[2][0]+.75*i[2][1]-.75*i[2][2]+.25*i[2][3],F=i[0][1]-2.5*i[1][1]+2*i[2][1]-.5*i[3][1],S=-.5*i[0][0]+.5*i[0][2]+1.25*i[1][0]-1.25*i[1][2]-i[2][0]+i[2][2]+.25*i[3][0]-.25*i[3][2],I=i[0][0]-2.5*i[0][1]+2*i[0][2]-.5*i[0][3]-2.5*i[1][0]+6.25*i[1][1]-5*i[1][2]+1.25*i[1][3]+2*i[2][0]-5*i[2][1]+4*i[2][2]-i[2][3]-.5*i[3][0]+1.25*i[3][1]-i[3][2]+.25*i[3][3],y=-.5*i[0][0]+1.5*i[0][1]-1.5*i[0][2]+.5*i[0][3]+1.25*i[1][0]-3.75*i[1][1]+3.75*i[1][2]-1.25*i[1][3]-i[2][0]+3*i[2][1]-3*i[2][2]+i[2][3]+.25*i[3][0]-.75*i[3][1]+.75*i[3][2]-.25*i[3][3],E=-.5*i[0][1]+1.5*i[1][1]-1.5*i[2][1]+.5*i[3][1],L=.25*i[0][0]-.25*i[0][2]-.75*i[1][0]+.75*i[1][2]+.75*i[2][0]-.75*i[2][2]-.25*i[3][0]+.25*i[3][2],C=-.5*i[0][0]+1.25*i[0][1]-i[0][2]+.25*i[0][3]+1.5*i[1][0]-3.75*i[1][1]+3*i[1][2]-.75*i[1][3]-1.5*i[2][0]+3.75*i[2][1]-3*i[2][2]+.75*i[2][3]+.5*i[3][0]-1.25*i[3][1]+i[3][2]-.25*i[3][3],k=.25*i[0][0]-.75*i[0][1]+.75*i[0][2]-.25*i[0][3]-.75*i[1][0]+2.25*i[1][1]-2.25*i[1][2]+.75*i[1][3]+.75*i[2][0]-2.25*i[2][1]+2.25*i[2][2]-.75*i[2][3]-.25*i[3][0]+.75*i[3][1]-.75*i[3][2]+.25*i[3][3]},H=function(t,i){var e=t*t,a=i*i,s=a*i;return d+p*i+m*a+w*s+(x+R*i+M*a+T*s)*t+(F+S*i+I*a+y*s)*e+(E+L*i+C*a+k*s)*(e*t)},b=-1,W={width:80,height:80,mime:"image/png",processType:0},A=function(){function t(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(i,e,a){return e&&t(i.prototype,e),a&&t(i,a),i}}(),z={container:"#imgclip",img:null,quality:.92,isConstrain:!0,isSmooth:!0,captureRadius:30,mime:"image/jpeg"},_=[],N={},Y=function(){function t(i){f(this,t),this.options=u({},z,i),this.container=g(this.options.container),this.clear(),this.img=this.options.img,this.initCanvas(),this.initClip(),this.initMagnifier(),this.initTransferCanvas(),this.clipRectReset()}return A(t,[{key:"clear",value:function(){for(var t=0;t<_.length;t+=1)this.container.removeChild(_[t]);_=[];for(var i=Object.keys(N),e=0;e<i.length;e+=1)this.container.removeEventListener(i[e],N[i[e]]);N={}}},{key:"initCanvas",value:function(){this.canvasFull=document.createElement("canvas"),this.ctxFull=this.canvasFull.getContext("2d"),this.smoothCtx(this.ctxFull),this.RATIO_PIXEL=t.getPixelRatio(this.ctxFull);var i=this.img.width/this.img.height,e=this.container.offsetWidth||window.innerWidth;this.oldWidth=e,this.oldHeight=e/i,this.resizeCanvas(e,this.oldHeight),this.container.appendChild(this.canvasFull),_.push(this.canvasFull)}},{key:"resizeCanvas",value:function(t,i){var e=t/i,a=this.oldWidth,s=a/e;this.canvasFull.style.width=a+"px",this.canvasFull.style.height=s+"px",this.canvasFull.width=a*this.RATIO_PIXEL,this.canvasFull.height=s*this.RATIO_PIXEL,1&this.rotateStep?this.scale=this.canvasFull.width/this.img.height:this.scale=this.canvasFull.width/this.img.width}},{key:"initClip",value:function(){var t=document.createElement("div");t.className="clip-rect",this.clipRect=t,this.container.appendChild(this.clipRect),_.push(this.clipRect);var i=document.createElement("span");i.className="clip-tips",this.clipRect.appendChild(i),this.clipTips=i,this.clipRectHorns=[];for(var e=0;e<8;e+=1){var a=document.createElement("span");a.className="clip-rect-horn ",0===e?a.className+="horn-nw":1===e?a.className+="horn-ne":2===e?a.className+="horn-sw":3===e?a.className+="horn-se":4===e?a.className+="horn-n":5===e?a.className+="horn-s":6===e?a.className+="horn-w":7===e&&(a.className+="horn-e"),this.clipRect.appendChild(a),this.clipRectHorns.push(a)}this.clipEventState={},this.resizeClip()}},{key:"resizeClip",value:function(){for(var t=this,i=function(i){t.canResizing=!0,t.saveEventState(i),t.canvasMag.classList.remove("clip-hidden")},e=function(){t.canResizing=!1,t.canvasMag.classList.add("clip-hidden")},a=0;a<8;a+=1)this.clipRectHorns[a].addEventListener("mousedown",i),this.clipRectHorns[a].addEventListener("touchstart",i),this.clipRectHorns[a].addEventListener("mouseup",e),this.clipRectHorns[a].addEventListener("touchend",e);this.container.addEventListener("mouseleave",e),this.container.addEventListener("mouseup",e),N.mouseleave=e,N.mouseup=e;var s=function(i){if(t.canResizing){i.preventDefault(),i.stopPropagation();var e=i.touches?i.touches[0].pageY:i.pageY,a=i.touches?i.touches[0].pageX:i.pageX,s=e-t.container.offsetTop,h=a-t.container.offsetLeft,n=t.clipEventState,c=n.evnt.target;t.options.isConstrain&&(s=Math.min(s,t.container.offsetHeight),s=Math.max(0,s),h=Math.min(h,t.container.offsetWidth),h=Math.max(0,h)),t.curX=h,t.curY=s;var r=void 0,o=void 0,l=void 0,v=void 0;c.classList.contains("horn-nw")?(r=n.width-(h-n.left),o=n.height-(s-n.top),l=h,v=s):c.classList.contains("horn-ne")?(r=h-n.left,o=n.height-(s-n.top),l=n.left,v=s):c.classList.contains("horn-sw")?(r=n.width-(h-n.left),o=s-n.top,l=h,v=n.top):c.classList.contains("horn-se")?(r=h-n.left,o=s-n.top,l=n.left,v=n.top):c.classList.contains("horn-n")?(r=n.width,o=n.height-(s-n.top),l=n.left,v=s):c.classList.contains("horn-s")?(r=n.width,o=s-n.top,l=n.left,v=n.top):c.classList.contains("horn-w")?(r=n.width-(h-n.left),o=n.height,l=h,v=n.top):c.classList.contains("horn-e")&&(r=h-n.left,o=n.height,l=h-r,v=n.top),t.rectOldLeft=l,t.rectOldTop=v,t.rectOldWidth=r,t.rectOldHeight=o,t.clipRect.style.left=l+"px",t.clipRect.style.top=v+"px",t.clipRect.style.width=r+"px",t.clipRect.style.height=o+"px",t.draw()}};this.container.addEventListener("touchmove",s),this.container.addEventListener("mousemove",s),N.touchmove=s,N.mousemove=s}},{key:"saveEventState",value:function(t){this.clipEventState.width=this.clipRect.offsetWidth,this.clipEventState.height=this.clipRect.offsetHeight,this.clipEventState.left=this.clipRect.offsetLeft,this.clipEventState.top=this.clipRect.offsetTop,this.clipEventState.mouseX=t.touches?t.touches[0].pageX:t.pageX,this.clipEventState.mouseY=t.touches?t.touches[0].pageY:t.pageY,this.clipEventState.evnt=t}},{key:"draw",value:function(){this.drawMag();var t=this.getRealFinalImgSize(this.clipRect.offsetWidth*this.RATIO_PIXEL,this.clipRect.offsetHeight*this.RATIO_PIXEL),i=t.width,e=t.height;this.clipTips.innerText=i.toFixed(0)+"*"+e.toFixed(0),this.ctxFull.save(),1&this.rotateStep?this.ctxFull.clearRect(0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.clearRect(0,0,this.canvasFull.width,this.canvasFull.height),this.drawImage(),this.drawMask(),this.ctxFull.beginPath();var a=this.getClipRectParams(),s=a.srcX,h=a.srcY,n=a.sWidth,c=a.sHeight;this.ctxFull.rect(s,h,n,c),this.ctxFull.clip(),this.drawImage(),this.ctxFull.restore()}},{key:"getClipRectParams",value:function(){var t=this.clipRect.offsetLeft,i=this.clipRect.offsetTop,e=this.clipRect.offsetWidth,a=this.clipRect.offsetHeight,s=this.clipRect.offsetTop,h=this.clipRect.offsetLeft,n=this.clipRect.offsetWidth,c=this.clipRect.offsetHeight,r=h+n,o=s+c;return 1===this.rotateStep?(t=s,i=this.container.offsetWidth-r,e=c,a=n):2===this.rotateStep?(t=this.container.offsetWidth-r,i=this.container.offsetHeight-o,e=n,a=c):3===this.rotateStep&&(t=this.container.offsetHeight-o,i=h,e=c,a=n),t*=this.RATIO_PIXEL,i*=this.RATIO_PIXEL,e*=this.RATIO_PIXEL,a*=this.RATIO_PIXEL,{srcX:t,srcY:i,sWidth:e,sHeight:a}}},{key:"getRealCoordinate",value:function(t,i){var e=t,a=i;return 1===this.rotateStep?(e=i,a=this.container.offsetWidth-t):2===this.rotateStep?(e=this.container.offsetWidth-t,a=this.container.offsetHeight-i):3===this.rotateStep&&(e=this.container.offsetHeight-i,a=t),e*=this.RATIO_PIXEL,a*=this.RATIO_PIXEL,{x:e,y:a}}},{key:"drawImage",value:function(){1&this.rotateStep?this.ctxFull.drawImage(this.img,0,0,this.img.width,this.img.height,0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.drawImage(this.img,0,0,this.img.width,this.img.height,0,0,this.canvasFull.width,this.canvasFull.height)}},{key:"drawMask",value:function(){this.ctxFull.save(),this.ctxFull.fillStyle="rgba(0, 0, 0, 0.3)",1&this.rotateStep?this.ctxFull.fillRect(0,0,this.canvasFull.height,this.canvasFull.width):this.ctxFull.fillRect(0,0,this.canvasFull.width,this.canvasFull.height),this.ctxFull.restore()}},{key:"drawMag",value:function(){var t=this.options.captureRadius,i=this.getRealCoordinate(this.curX,this.curY),e=i.x-t,a=i.y-t,s=2*t,h=2*t;1&this.rotateStep?this.ctxMag.clearRect(0,0,this.canvasMag.height,this.canvasMag.width):this.ctxMag.clearRect(0,0,this.canvasMag.width,this.canvasMag.height),this.ctxMag.drawImage(this.img,e/this.scale,a/this.scale,s/this.scale,h/this.scale,0,0,this.canvasMag.width,this.canvasMag.height);var n=this.canvasMag.width/2,c=this.canvasMag.height/2,r=5*this.RATIO_PIXEL;this.ctxMag.beginPath(),this.ctxMag.moveTo(n-r,c),this.ctxMag.lineTo(n+r,c),this.ctxMag.moveTo(n,c-r),this.ctxMag.lineTo(n,c+r),this.ctxMag.strokeStyle="#de3c50",this.ctxMag.lineWidth=3,this.ctxMag.stroke()}},{key:"initMagnifier",value:function(){this.canvasMag=document.createElement("canvas"),this.canvasMag.className="magnifier clip-hidden",this.ctxMag=this.canvasMag.getContext("2d"),this.smoothCtx(this.ctxMag),this.container.appendChild(this.canvasMag),_.push(this.canvasMag),this.canvasMag.width=2*this.options.captureRadius*this.RATIO_PIXEL,this.canvasMag.height=2*this.options.captureRadius*this.RATIO_PIXEL}},{key:"initTransferCanvas",value:function(){this.canvasTransfer=document.createElement("canvas"),this.canvasTransfer.style.display="none",this.canvasTransfer.className="transfer-canvas",this.ctxTransfer=this.canvasTransfer.getContext("2d"),this.smoothCtx(this.ctxTransfer),this.container.appendChild(this.canvasTransfer),_.push(this.canvasTransfer)}},{key:"smoothCtx",value:function(t){var i=this.options.isSmooth;t.mozImageSmoothingEnabled=i,t.webkitImageSmoothingEnabled=i,t.msImageSmoothingEnabled=i,t.imageSmoothingEnabled=i}},{key:"getRealFinalImgSize",value:function(t,i){var e=t,a=i;return 1&this.rotateStep?this.canvasFull.width>this.img.height&&(e=this.img.width*t/this.canvasFull.height,a=this.img.height*i/this.canvasFull.width):this.canvasFull.width>this.img.width&&(e=this.img.width*t/this.canvasFull.width,a=this.img.height*i/this.canvasFull.height),{width:e,height:a}}},{key:"clip",value:function(){var t=this.getClipRectParams(),i=t.srcX,e=t.srcY,a=t.sWidth,s=t.sHeight,h=this.getRealFinalImgSize(a,s),n=h.width,c=h.height;this.rotateStep=this.rotateStep||0;var r=90*this.rotateStep*Math.PI/180;0===this.rotateStep?(this.canvasTransfer.width=n,this.canvasTransfer.height=c):1===this.rotateStep?(this.canvasTransfer.width=c,this.canvasTransfer.height=n,this.ctxTransfer.rotate(r),this.ctxTransfer.translate(0,-this.canvasTransfer.width)):2===this.rotateStep?(this.canvasTransfer.width=n,this.canvasTransfer.height=c,this.ctxTransfer.rotate(r),this.ctxTransfer.translate(-this.canvasTransfer.width,-this.canvasTransfer.height)):3===this.rotateStep&&(this.canvasTransfer.width=c,this.canvasTransfer.height=n,this.ctxTransfer.rotate(r),this.ctxTransfer.translate(-this.canvasTransfer.height,0)),1&this.rotateStep?this.ctxTransfer.drawImage(this.img,i/this.scale,e/this.scale,a/this.scale,s/this.scale,0,0,this.canvasTransfer.height,this.canvasTransfer.width):this.ctxTransfer.drawImage(this.img,i/this.scale,e/this.scale,a/this.scale,s/this.scale,0,0,this.canvasTransfer.width,this.canvasTransfer.height),this.clipImgData=this.canvasTransfer.toDataURL(this.options.mime,this.options.quality)}},{key:"clipRectReset",value:function(){this.clipRect.style.left=0,this.clipRect.style.top=0,this.clipRect.style.width=this.canvasFull.width/this.RATIO_PIXEL+"px",this.clipRect.style.height=this.canvasFull.height/this.RATIO_PIXEL+"px",this.draw()}},{key:"getClipImgData",value:function(){return this.clipImgData}},{key:"rotate",value:function(t){var i=this.oldWidth,e=this.oldHeight;this.rotateStep=this.rotateStep||0,this.rotateStep+=t?1:-1,this.rotateStep>3?this.rotateStep=0:this.rotateStep<0&&(this.rotateStep=3);var a=90*this.rotateStep*Math.PI/180;this.canvasMag.width=this.canvasMag.width,this.canvasMag.height=this.canvasMag.height,0===this.rotateStep?this.resizeCanvas(i,e):1===this.rotateStep?(this.resizeCanvas(e,i),this.ctxFull.rotate(a),this.ctxFull.translate(0,-this.canvasFull.width),this.ctxMag.rotate(a),this.ctxMag.translate(0,-this.canvasMag.width)):2===this.rotateStep?(this.resizeCanvas(i,e),this.ctxFull.rotate(a),this.ctxFull.translate(-this.canvasFull.width,-this.canvasFull.height),this.ctxMag.rotate(a),this.ctxMag.translate(-this.canvasMag.width,-this.canvasMag.height)):3===this.rotateStep&&(this.resizeCanvas(e,i),this.ctxFull.rotate(a),this.ctxFull.translate(-this.canvasFull.height,0),this.ctxMag.rotate(a),this.ctxMag.translate(-this.canvasMag.height,0)),this.clipRectReset()}},{key:"destroy",value:function(){this.clear(),this.canvasFull=null,this.ctxFull=null,this.canvasTransfer=null,this.ctxTransfer=null,this.canvasMag=null,this.ctxMag=null,this.clipRect=null}}],[{key:"getPixelRatio",value:function(t){var i=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/i}}]),t}(),D={};return function(t){t.scaleImage=function(t,e){var a=t.width,h=t.height,c=u({},W,e),r=[i,s,n,v],o=document.createElement("canvas"),l=o.getContext("2d");o.width=a,o.height=h,l.drawImage(t,0,0,a,h);var g=l.getImageData(0,0,a,h),f=l.createImageData(c.width,c.height);return f=r[c.processType](g,f,c),o.width=f.width,o.height=f.height,l.putImageData(f,0,0,0,0,o.width,o.height),console.log(g),console.log(f),o.toDataURL(c.mime,.9)}}(D),function(t){t.ImgClip=Y}(D),D});